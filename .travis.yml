dist: xenial
language: go
os: linux

services:
  - docker

go:
  - 1.15.x
  - 1.14.x
  - master

# skip non-trunk PMM-XXXX branch builds, but still build pull requests
branches:
  except:
    - /^PMM\-\d{4}/

go_import_path: github.com/percona/proxysql_exporter

cache:
  directories:
    - /home/travis/.cache/go-build
    # - /home/travis/gopath/pkg

before_cache:
  - go clean -testcache
  # - go clean -cache

env:
  global:
    # REVIEWDOG_GIHUB_API_TOKEN
    - secure: LPTrIFaBIby963whrpbMDq9cqWCbqVCjtDJEfEe/rj/LT5GHC82vEFbEfuGmwrtzRJOfVEgjQ8fXgfCoU9rjpvZ9ZHZAPuI7ZTSGK7PN7cahb8mFKdawqLAS9SYXRxDBFV88/i2l74T7wK1/vNkM4wMRxg9U0rvhSCpuFO97Lkl+QHcaLox2a5QhPS5fW1c+6eWseeA2F+dBT6XmK6K6iq7P9v8U3ODMq1gTQbgl1fkfsO7PZtf3s/urU2dEAP5If9t2sDSd4eU8xPu/r6cEZ0lxU1wI3GqZ1lxfzMqGQ3aVtyFxK8MZP5dzwXHnZM9W7HVkU7IwhMPowusiRzr6iHCaplfQ6zKWAb6sdY03sYKwh0Gixhr8bmvzHkAMyIiuR8zjpXI74aG2SeawPLGas2gm3BijNBXq/AX8hWuDNRle4uT9dma7wf/+YBBwp7Wf7Uqju0rWBrjU3iodzhnTmLDHYLCu6CesHYSvdzFfTzUsnmEm/8QDvArT27Ht+EnI9XkupLbcb1zaKPm5vaYoYkSlgV46hUpMoRGLnRdMNsDWpMfA7DbYhVDWgSJq4L0HpwFRvnCVrk8rZa2BHSNNIIXxzy4gpdLzlZhhEqVjCz0ooOh4DjWJXVXbSDn54E9hMKoD3Eb+6FF4zKoomT3be2JVG8GKGntsTP2zDy2F0tI=
  matrix:
    - PROXYSQL_IMAGE=percona/proxysql:1.2.1
    - PROXYSQL_IMAGE=perconalab/proxysql:1.3.6

install:
  # install reviewdog and golangci-lin
  - curl https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh| sh -s
  - curl https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s latest

before_script:
  # static analyze
  - bin/golangci-lint run -c=.golangci-required.yml --out-format=line-number | bin/reviewdog -f=golangci-lint -level=error -reporter=github-pr-check
  - bin/golangci-lint run -c=.golangci.yml --out-format=line-number | bin/reviewdog -f=golangci-lint -level=error -reporter=github-pr-review
  - docker --version
  - docker-compose --version
  - docker-compose up -d

script:
  - make format build testall

after_success:
  - bash <(curl -s https://codecov.io/bash) -X fix

notifications:
  slack:
    on_success: change
    on_failure: always
    rooms:
      - secure: ohAnyf4vfCkvKhSZNNNR6TwxIiavVqLueyPE5zBTVs6mJZV6gJRkVdGIyDGQDnvziJqWAkUIZo6cqmNhqV/4uv99uP9n/zQiefnhJ9jfNpWE2aJz5zZQA9O6/uLpgNIeZlsMYu4rZWUgsvJK58myke9S+NAcuA1qpBSiFpJ5zlcSvwEs0uNrWXfoW4g+DwjkkUbNtCWNJBinlvhhuxWfiFpm9yVyZoZl9FOaewWBIroik4zrtMqOJO16JV2kv4miIhAKfvILbdWgM6Rfh2Wk5HE73onJqQkh9X87E4ey5jIaPL6wObDqYlGfYP4K8jMmddelIT/Ka7WXZ9lo36EE0hjNzwRkTXwIC1Fi8fbfUdQpxPBMtuYsuAo42Z3V1f2KALq+dGOMs0HmvYsv24P4zCXTKQAmzCcDDLUQwfUuS6gJiBSNTzxnMi+A0eQBwQRjCGggQwWqaKgxB+B/XBdls+JJxaFKoPh13tJtDzZ++zNZS32SIVAvml1Bje5nW2B6+fkolWkuhKtwBt3zPqHLZ1kDYfkzTSqQgGWU+1L82ukn5NYPiUhM4d+3HD7KPe8kgW9kdM2PQMVLhV5b0SOwP9DMpexrKn/fcDk2/CYNzGRNIqFbzGhc+gShI+lJl8s5dhMuOznnjKxoNaCzVR8OK5xsTtGoN7UCogZaZ4AjF6U=
